<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Raphael :: Drag-n-drop</title>
        
		<script src="raphael.js"></script>
        
		<script>
            function Pin(component, name)
            {
				return {
					name: name,
					component: component,
					
					connections: [],

					src: null,
					i: null,
					u: null,

					connect: function(pin) {
						this.connections.push(pin);
						pin.connections.push(this);
						return this;
					}
				};
            }

            function Component(type, name)
            {
				return {
					pins: [],
					
					type: type,
					name: name || 'unnamed_component',

					invoke: function(pin, I, U) {
					},
					
					conduction: function(pinB) {
					},

					pin: function(name) {
						for (var i = 0; i < this.pins.length; i++) {
							if (this.pins[i].name == name)
								return this.pins[i];
						}

						return null;
					}
				}
            }
			</script>
			
			<script type="text/javascript">
			Resistor = function(name, R) {
				var tmp = new Component('resistor');
				
				tmp.name = name;
				tmp.R = R;
				
				tmp.pins.push(new Pin(tmp, 'a'));
				tmp.pins.push(new Pin(tmp, 'b'));
				
				tmp.invoke = function(pin, I, U) {
					if (pin == this.pin('a') && this.pin('b').src == 'negative') {
						this.pin('b').i = I;
						this.pin('b').u = U;
						
						console.log(this.name, '!');
					} else
					if (pin == this.pin('b') && this.pin('a').src == 'negative') {
						this.pin('a').i = I;
						this.pin('a').u = U;
						
						console.log(this.name, '!');
					}
				}
				
				tmp.conduction = function(pinB) {
					return true;
				}
				
				return tmp;
			}
			</script>
			
			<script type="text/javascript">
			Diode = function(name) {
				var tmp = new Component('diode');
				
				tmp.name = name;
				
				tmp.pins.push(new Pin(tmp, 'anode'));
				tmp.pins.push(new Pin(tmp, 'cathode'));
				
				tmp.invoke = function(pin, I, U) {
					if (pin == this.pin('anode') && this.pin('cathode').src == 'negative') {
						this.pin('cathode').i = I;
						this.pin('cathode').u = U;
						
						console.log(this.name, '!');
					}
				}
				
				tmp.conduction = function(pinB) {
					if (pinB.name == 'cathode')
						return true; else
							return false;
				}
				
				return tmp;
			}
			</script>
			
			<script type="text/javascript">
			Wire = function(name) {
				var tmp = new Component('wire');
				
				tmp.name = name;
				
				tmp.invoke = function(pin, I, U) {
					for (var i = 0; i < this.pins.length; i++) {
						if (this.pins[i] == pin)
							continue;
							
						this.pins[i].i = I;
						this.pins[i].u = U;
					}
				}
				
				tmp.conduction = function(pinB) {
					return true;
				}
				
				tmp.connect = function(pin) {
					var lastPin = tmp.pins[tmp.pins.length - 1], N = (parseInt(lastPin ? lastPin.name : 0)) + 1, p = new Pin(tmp, N);
					p.connect(pin);
					tmp.pins.push(p);
					return p;
				}
				
				return tmp;
			}
			</script>
			
			<script type="text/javascript">
			function Scheme() {
				return {
					components: [],
					
					add: function(component) {
						this.components.push(component);
					},
					
					component: function(name, type) {
						for (var i = 0; i < this.components.length; i++) {
							var c = this.components[i];
							
							if (this.name && this.type) {
								if (c.name == name && c.type == type)
									return c;
							} else
							if (this.type) {
								if (c.type == type)
									return c;
							} else {
								if (c.name == name)
									return c;
							}
						}
					},
					
					run: function(src) {
						var q = [].concat(src.pin('negative').connections), stopFlag = 0, controlFlag = src.pin('positive').connections.length;
						
						while (q.length > 0) {
							if (stopFlag > controlFlag) {
								console.log('Stopping backward iteration');
								break;
							}
								
							for (var i = 0; i < q.length; i++) {
								if (q[i] == src.pin('positive'))
									stopFlag++;
							}
							
							var p = q.shift();
							
							p.src = 'negative';
							
							for (var i = 0; i < p.component.pins.length; i++) {
								var p2 = p.component.pins[i];
								
								if (p != p2 && p.component != src && p2.component.conduction(p)) {
									for (var t = 0; t < p2.connections.length; t++) {
										q.push(p2.connections[t]);
										//p2.connections[t].src = 'negative';
									}
								}
							}
						}
						
						var q = [].concat(src.pin('positive').connections), stopFlag = 0, controlFlag = src.pin('negative').connections.length;
						
						for (var i = 0; i < q.length; i++) {
							q[i].i = src.pin('positive').i;
							q[i].u = src.pin('positive').u;
						}
						
						while (q.length > 0) {
							if (stopFlag > controlFlag) {
								console.log('Stopping forward iteration');
								break;
							}
							
							for (var i = 0; i < q.length; i++) {
								if (q[i] == src.pin('negative'))
									stopFlag++;
							}
							
							var p = q.shift();
							
							p.component.invoke(p, p.i, p.u);
							
							for (var i = 0; i < p.component.pins.length; i++) {
								var p2 = p.component.pins[i];
								
								if (p2 != p && p2.u && p2.i)
									for (var t = 0; t < p2.connections.length; t++) {
										p2.connections[t].i = p2.i;
										p2.connections[t].u = p2.u;
										q.push(p2.connections[t]);
									}
							}
						}
					}
				}
			}
        </script>
		
		<script type="text/javascript">
		var Cs = new Scheme();
		
		var a = new Component('dc_source', 'src1');
		a.pins.push(new Pin(a, 'positive'));
		a.pins.push(new Pin(a, 'negative'));
		a.pin('positive').i = 1;
		a.pin('positive').u = 5;
		Cs.add(a);
		
		var a = new Resistor('r1', 1);
		Cs.add(a);
		
		var a = new Diode('vd1');
		Cs.add(a);
		
		var a = new Wire('-1');
		Cs.add(a);
		
		var a = new Wire('-2');
		Cs.add(a);
		
		Cs.component('-1').connect(Cs.component('vd1').pin('anode'));
		Cs.component('-2').connect(Cs.component('vd1').pin('cathode'));
		
		Cs.component('-1').connect(Cs.component('src1').pin('positive'));
		Cs.component('-1').connect(Cs.component('r1').pin('a'));
		
		Cs.component('-2').connect(Cs.component('src1').pin('negative'));
		Cs.component('-2').connect(Cs.component('r1').pin('b'));
		
		Cs.run(Cs.component('src1'));
		</script>

        <script type="text/javascript">
            window.onload = function () {
				var cellSize = 25;
				
                var R = Raphael(0, 0, "100%", "100%"),
                    r = R.circle(100, 100, 50).attr({fill: "hsb(0, 1, 1)", stroke: "none", opacity: .5}); /*,
                    g = R.circle(210, 100, 50).attr({fill: "hsb(.3, 1, 1)", stroke: "none", opacity: .5}),
                    b = R.circle(320, 100, 50).attr({fill: "hsb(.6, 1, 1)", stroke: "none", opacity: .5}),
                    p = R.circle(430, 100, 50).attr({fill: "hsb(.8, 1, 1)", stroke: "none", opacity: .5});*/
					
                var start = function () {
                    this.ox = this.attr("cx");
                    this.oy = this.attr("cy");
                    //this.animate({r: 70, opacity: .25}, 500, ">");
                },
				
                move = function (dx, dy) {
					var x = Math.floor((this.ox + dx) / cellSize) * cellSize, y = Math.floor((this.oy + dy) / cellSize) * cellSize;
                    this.attr({cx: x, cy: y});
                },
				
                up = function () {
                    //this.animate({r: 50, opacity: .5}, 500, ">");
                };
				
                //R.set(r, g, b, p).drag(move, start, up);
				r.drag(move, start, up);
            };
        </script>
    </head>
	
    <body>
        <div id="holder"></div>
    </body>
</html>